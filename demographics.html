<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MentalStats: Demographics</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
    
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <h1>MentalStats</h1>
        </div>
    </header>
    <main>
        <div class="layout-wrapper">
            <nav class="sidebar">
                <ul class="nav-links">
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="analytics.html">Analytics</a></li>
                    <li><a href="#" class="active">Demographics</a></li>
                    <li><a href="explore.html">Explore</a></li>
                </ul>
            </nav>
            <div class="main-container">
                
                <div class="chart-container">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h2>Ages of Samples</h2>
                        </div>
                            <div class="controls">
                                <label for="ageSort" class="label-style">Sort by:</label>
                                <select id="ageSort">
                                    <option value="default">Age (Default)</option>
                                    <option value="high-low">Count (High-Low)</option>
                                    <option value="low-high">Count (Low-High)</option>
                                </select>
                            </div>
                        <div id="ageChart" class="d3-container"></div>
                    </div>

                    <div class="donut-chart-container">
                        <h2>Gender of Samples</h2>
                        <div id="genderChart" class="d3-container" style="height: 300px;"></div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="bar1-chart">
                        <div class="bar1-chart-header">
                            <h2>Course/ Demographics</h2>
                            <div class="controls-2">
                                <label style="color: black;">Sort By:</label>
                                <select id="courseSort">
                                    <option value="default">Name (A-Z)</option>
                                    <option value="high-low" selected>Count (High-Low)</option>
                                    <option value="low-high">Count (Low-High)</option>
                                </select>
                            </div>
                        </div>
                        <div id="courseChart" class="d3-container"></div>
                    </div>

                    <div class="bar2-chart">
                        <div class="bar2-chart-header">
                            <h2>Average Stress Index by Course & Gender</h2>
                            <div class="controls-2">
                                <label style="color: white;">Sort By:</label>
                                <select id="stressSort">
                                    <option value="default">Name (A-Z)</option>
                                    <option value="high-low">Avg Stress (High-Low)</option>
                                    <option value="low-high">Avg Stress (Low-High)</option>
                                </select>
                            </div>
                        </div>  
                        <div id="averageStressChart" class="d3-container"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="d3-tooltip" class="tooltip"></div>
    </main>

    <footer>
        <div class="footer-container">
            <div class="footer-header-container">
                <h2>MentalStats</h2>
                    <div class="footer-information-container">
                        <p>This website is for educational purposes only. This website is not for actual use and does not intend to be used for fraud or other illegal use</p>
                    </div>
            </div>
        <div class="source-section-container">
            <div class="source-header-container">
                <h2>Sources</h2>
                <div class="source-links-container">
                    <a href="https://borealisdata.ca/dataset.xhtml?persistentId=doi:10.5683/SP3/VEIBVL">Borealis: University Student Mental Health</a>
                    <a href="https://www.kaggle.com/datasets/shariful07/student-mental-health">Kaggle: Student Mental Health</a>
                </div>
            </div>
        </div>
            <div class="source-section-container">
                <div class="source-header-container">
                    <h2>Authored By:</h2>
                    <div class="source-links-container">
                        <p>Prinze Kyle Santiago</p>
                    </div>
                </div>
                <div class="source-header-container">
                    <h2>Section:</h2>
                    <div class="source-links-container">
                        <p>BSIT-3A</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <script>
        // Global Variables
        let rawDataGlobal = [];
        let allMonths = [];

        // Tooltip Helpers
        const tooltip = d3.select("#d3-tooltip");
        const showTooltip = (event, htmlContent) => {
            tooltip.transition().duration(200).style("opacity", .9);
            tooltip.html(htmlContent)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 28) + "px");
        };
        const hideTooltip = () => tooltip.transition().duration(500).style("opacity", 0);

        function getDimensions(id) {
            const el = document.getElementById(id);
            if(!el) return { width: 400, height: 400 };
            const rect = el.getBoundingClientRect();
            return { width: rect.width, height: rect.height || 350 };
        }

        
        // Load CSV and Process Data
        d3.csv("Final Combined Dataset.csv").then(function(data) {
            
            // Parsers
            const parseDate = d3.timeParse("%d/%m/%Y %H:%M");
            const parseDateISO = d3.timeParse("%Y-%m-%d %H:%M:%S");
            const formatMonth = d3.timeFormat("%b %Y");

            // Process Rows
            data.forEach(d => {
                let date = parseDate(d.Timestamp);
                if (!date) date = parseDateISO(d.Timestamp);
                if (!date) date = new Date(d.Timestamp);

                rawDataGlobal.push({
                    date: date,
                    monthStr: formatMonth(date),
                    age: +d.Age,
                    gender: d.Gender,
                    course: d["Course/Program"],
                    score: +d["Stress Index Score"]
                });
            });

            // Sort & Extract Months
            rawDataGlobal.sort((a, b) => a.date - b.date);
            allMonths = [...new Set(rawDataGlobal.map(d => d.monthStr))];

            // Initialize & Draw
            setupControls();
            updateAllCharts();

            // Resize Event
            window.addEventListener('resize', updateAllCharts);

        }).catch(err => console.error("Error loading CSV:", err));

        function setupControls() {
            // Dropdown IDs
            const ageSort = document.getElementById('ageSort');
            const courseSort = document.getElementById('courseSort');
            const stressSort = document.getElementById('stressSort');
            const startSel = document.getElementById('stressStartMonth');
            const endSel = document.getElementById('stressEndMonth');
            
            // Populate Months
            if(startSel && endSel) {
                allMonths.forEach((m, i) => {
                    startSel.add(new Option(m, i));
                    endSel.add(new Option(m, i));
                });
                startSel.value = 0; 
                endSel.value = allMonths.length - 1;

                startSel.addEventListener('change', updateStressChart);
                endSel.addEventListener('change', updateStressChart);
            }

            // Add Listeners
            if(ageSort) ageSort.addEventListener('change', updateAgeChart);
            if(courseSort) courseSort.addEventListener('change', updateCourseChart);
            if(stressSort) stressSort.addEventListener('change', updateStressChart);
        }

        function updateAllCharts() {
            updateAgeChart();
            updateGenderChart();
            updateCourseChart();
            updateStressChart();
        }

        // Chart 1: Age Chart (Bar)
        function updateAgeChart() {
            const containerId = "#ageChart";
            d3.select(containerId).html("");
            
            const map = d3.rollup(rawDataGlobal, v => v.length, d => d.age);
            let data = Array.from(map, ([key, val]) => ({ label: key, value: val }));
            
            // 1. Process Data
            const sortType = document.getElementById('ageSort').value;
            if (sortType === 'high-low') data.sort((a, b) => b.value - a.value);
            else if (sortType === 'low-high') data.sort((a, b) => a.value - b.value);
            else data.sort((a, b) => a.label - b.label);

            // 2. Setup Dimensions
            const { width, height } = getDimensions("ageChart");
            const margin = {top: 20, right: 20, bottom: 40, left: 40};
            const w = width - margin.left - margin.right;
            const h = height - margin.top - margin.bottom;

            const svg = d3.select(containerId).append("svg").attr("width", width).attr("height", height)
                .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand().range([0, w]).domain(data.map(d => d.label)).padding(0.2);
            const y = d3.scaleLinear().range([h, 0]).domain([0, d3.max(data, d => d.value) * 1.1]);

            svg.append("g").attr("transform", `translate(0,${h})`).attr("class", "dark-theme-axis").call(d3.axisBottom(x));
            svg.append("g").attr("class", "dark-theme-axis").call(d3.axisLeft(y));

            svg.selectAll("rect").data(data).join("rect")
                .attr("x", d => x(d.label)).attr("y", d => y(d.value))
                .attr("width", x.bandwidth()).attr("height", d => h - y(d.value))
                .attr("fill", "#36A2EB")
                .on("mouseover", (e, d) => showTooltip(e, `Age ${d.label}: ${d.value} students`))
                .on("mouseout", hideTooltip);
        }

        // Chart 2: Gender Chart
        function updateGenderChart() {
            const containerId = "#genderChart";
            d3.select(containerId).html("");

            // 1. Process Data
            const map = d3.rollup(rawDataGlobal, v => v.length, d => d.gender);
            const data = Array.from(map, ([key, val]) => ({ label: key, value: val }));

            // 2. Setup Dimensions
            const { width, height } = getDimensions("genderChart");
            const radius = Math.min(width, height) / 2 - 20;

            const svg = d3.select(containerId).append("svg").attr("width", width).attr("height", height)
                .append("g").attr("transform", `translate(${width/2},${height/2})`);

            // 3. Setup Arc & Pie
            const color = d3.scaleOrdinal().range(["#FF6384", "#36A2EB", "#FFCE56"]);
            const pie = d3.pie().value(d => d.value).sort(null); // .sort(null) keeps order consistent
            const arc = d3.arc().innerRadius(radius * 0.6).outerRadius(radius);

            // 4. Draw Slices
            svg.selectAll('path')
                .data(pie(data))
                .join('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.label))
                .attr("stroke", "white")
                .style("stroke-width", "2px")
                .on("mouseover", (e, d) => showTooltip(e, `${d.data.label}: ${d.data.value}`))
                .on("mouseout", hideTooltip);

            // 5. Add Numbers Inside Slices
            svg.selectAll('.slice-label')
                .data(pie(data))
                .join('text')
                .text(d => d.data.value) // Displays the number 
                .attr("transform", d => `translate(${arc.centroid(d)})`) 
                .style("text-anchor", "middle")
                .style("font-size", "12px")
                .style("fill", "white") 
                .style("font-weight", "bold")
                .style("pointer-events", "none"); 

            // 6. Draw Total in Center
            svg.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em") 
                .style("font-size", "14px")
                .style("fill", "#333")
                .text("Total: " + rawDataGlobal.length);
        }

        // Chart 3: Course Chart
        function updateCourseChart() {
            const containerId = "#courseChart";
            d3.select(containerId).html("");

            // 1. Process Data
            const map = d3.rollup(rawDataGlobal, v => v.length, d => d.course);
            let data = Array.from(map, ([key, val]) => ({ label: key, value: val }));

            // 2. Sort
            const sortType = document.getElementById('courseSort').value;
            if (sortType === 'high-low') data.sort((a, b) => b.value - a.value);
            else if (sortType === 'low-high') data.sort((a, b) => a.value - b.value);
            else data.sort((a, b) => a.label.localeCompare(b.label));

            // 3. Setup Dimensions
            const { width, height } = getDimensions("courseChart");
            const margin = {top: 20, right: 30, bottom: 20, left: 180}; 
            const w = width - margin.left - margin.right;
            const h = height - margin.top - margin.bottom;

            const svg = d3.select(containerId).append("svg").attr("width", width).attr("height", height)
                .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // 4. Scales
            const x = d3.scaleLinear().domain([0, d3.max(data, d => d.value)*1.1]).range([0, w]);
            const y = d3.scaleBand().domain(data.map(d => d.label)).range([0, h]).padding(0.2);

            // Define a palette of colors to cycle through
            const colorPalette = [
                "#36A2EB", "#FF6384", "#4BC0C0", "#FF9900", "#9966FF", 
                "#FFCD56", "#115c19", "#3366CC", "#DC3912", "#109618"
            ];
            const colorScale = d3.scaleOrdinal()
                .domain(data.map(d => d.label))
                .range(colorPalette);

            // 5. Draw Axes
            svg.append("g").attr("transform", `translate(0,${h})`).call(d3.axisBottom(x)).attr("class", "light-theme-axis");
            svg.append("g").call(d3.axisLeft(y)).attr("class", "light-theme-axis");

            // 6. Draw Bars with Multiple Colors
            svg.selectAll("rect").data(data).join("rect")
                .attr("x", x(0))
                .attr("y", d => y(d.label))
                .attr("width", d => x(d.value))
                .attr("height", y.bandwidth())
                .attr("fill", d => colorScale(d.label)) // <--- Apply Color Scale Here
                .on("mouseover", (e, d) => showTooltip(e, `${d.label}: ${d.value}`))
                .on("mouseout", hideTooltip);
        }

        // Chart 4: Stress Chart
        function updateStressChart() {
            const containerId = "#averageStressChart";
            d3.select(containerId).html("");

            // 1. Use Global Data Directly 
            if (rawDataGlobal.length === 0) return; // Waits for data load

            // 2. Group: Course -> Gender -> Avg Score
            const groups = d3.rollups(rawDataGlobal, 
                v => d3.mean(v, d => d.score), 
                d => d.course,
                d => d.gender
            );

            // 3. Flatten Data
            let data = groups.map(([course, genderData]) => {
                let row = { course: course, avgTotal: 0, count: 0 };
                
                // genderData is an array of [gender, score] pairs. 
                genderData.forEach(([gender, score]) => {
                    row[gender] = score; // Set row.Male or row.Female
                    row.avgTotal += score;
                    row.count++;
                });
                
                row.avgTotal = row.avgTotal / row.count; 
                return row;
            });

            // 4. Sort Data
            const sortType = document.getElementById('stressSort').value;
            if (sortType === 'high-low') data.sort((a, b) => b.avgTotal - a.avgTotal);
            else if (sortType === 'low-high') data.sort((a, b) => a.avgTotal - b.avgTotal);
            else data.sort((a, b) => a.course.localeCompare(b.course));

            // 5. Setup Dimensions
            const { width, height } = getDimensions("averageStressChart");
            const margin = {top: 40, right: 20, bottom: 100, left: 40}; 
            const w = width - margin.left - margin.right;
            const h = height - margin.top - margin.bottom;

            const svg = d3.select(containerId).append("svg").attr("width", width).attr("height", height)
                .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // 6. Scales
            const x0 = d3.scaleBand().rangeRound([0, w]).paddingInner(0.1).domain(data.map(d => d.course));
            const subgroups = ["Male", "Female"];
            const x1 = d3.scaleBand().domain(subgroups).rangeRound([0, x0.bandwidth()]).padding(0.05);
            const y = d3.scaleLinear().domain([0, 100]).range([h, 0]);
            const color = d3.scaleOrdinal().domain(subgroups).range(["#36A2EB", "#FF6384"]);

            // 7. Draw Axes
            svg.append("g").attr("transform", `translate(0,${h})`).attr("class", "dark-theme-axis").call(d3.axisBottom(x0))
                .selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");
            
            svg.append("g").attr("class", "dark-theme-axis").call(d3.axisLeft(y).ticks(5));

            // 8. Draw Bars
            const barGroups = svg.selectAll(".g").data(data).join("g").attr("transform", d => `translate(${x0(d.course)},0)`);
            
            barGroups.selectAll("rect")
                .data(d => subgroups.map(key => ({key, value: d[key], course: d.course})))
                .join("rect")
                .attr("x", d => x1(d.key))
                .attr("y", d => (d.value !== undefined) ? y(d.value) : h) // Handle missing values safely
                .attr("width", x1.bandwidth())
                .attr("height", d => (d.value !== undefined) ? h - y(d.value) : 0)
                .attr("fill", d => color(d.key))
                .on("mouseover", (e, d) => showTooltip(e, `${d.course} (${d.key}): ${d.value ? Math.round(d.value) : 'N/A'}`))
                .on("mouseout", hideTooltip);

            // 9. Legend
            const legend = svg.append("g").attr("transform", `translate(${w - 70}, -30)`);
            subgroups.forEach((gender, i) => {
                legend.append("rect").attr("y", i * 20).attr("width", 10).attr("height", 10).attr("fill", color(gender));
                legend.append("text").attr("x", 15).attr("y", i * 20 + 9).text(gender).style("fill", "white").style("font-size", "10px");
            });
        }
    </script>
</body>
</html>